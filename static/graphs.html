<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Vizard Graphs</title>
		<style>
			#countries, #users {
				width: 500px;
				height: 400px;
			}
			.left {
				float: left;
			}
		</style>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script> 
		<script type="text/javascript" src="js/highcharts.js"></script>
		<script>
			var vizarder = function(id, type) {
				var chart;
				var firstData = {
					categories: [],
					values: []
				};
				
				$(function() {
					chart = new Highcharts.Chart({
						chart: {
							renderTo: id,
							defaultSeriesType: type
						},
						credits: {
							enabled: false
						},
						legend: {
							enabled: false
						},
						title: {
							text: ''
						},
						xAxis: {
							categories: firstData.categories,
							labels: {
								step: (type === 'line' ? 50 : null)
							}
						},
						yAxis: {
							min: 0,
							title: {
								text: ''
							}
						},
						plotOptions: {
							column: {
								pointPadding: 0.2,
								borderWidth: 0
							}
						},
						tooltip: {
							formatter: function() {
								return this.x + ' : <b>' + this.y + '</b>';
							}
						},
						series: [{
							data: firstData.values
						}]
					});
				});
				
				return {
					set: function(data) {
						if (!chart) {
							for (var category in data.values) {
								firstData.categories.push(category);
								firstData.values.push(data.values[category]);
							}
							return;
						}

						/* Here follows: Super-Advanced-Diff-Algorithm-By-Bjarke */

						var mustRedraw = false;

/*
						// Store list of current bars in chart.
						var currentCategories = {};
						chart.series[0].data.forEach(function(point) {
							currentCategories[point.category] = point;
						});

						// Remove bars not needed any more.
						Object.keys(currentCategories).forEach(function(category) {
							if (!(category in data.values)) {
								// Current category not in new data, so remove the bar.
								currentCategories[category].remove(false, true);
								mustRedraw = true;
							}
						});

						// Update existing points as needed.
						var addCategories = {};
						Object.keys(data.values).forEach(function(category) {
							var value = data.values[category];
							if (category in currentCategories) {
								var point = currentCategories[category];
								if (point.y !== value) {
									point.update(value, false, true);
									mustRedraw = true;
								}
							} else {
								addCategories[category] = value;
							}
						});

						// Create new bars as needed.
						var series = chart.series[0];
						var categories = chart.xAxis[0].categories;
						for (var category in addCategories) {
							var value = addCategories[category];
							series.addPoint(value, false, false, true);
							categories.push(category);
							mustRedraw = true;
						}
*/
						var series = chart.series[0];
						var categories = chart.xAxis[0].categories;
						var numberOfBars = categories.length;
						var index = 0;
						var modifiedBars = [];

						for (var category in data.values) {
							var value = data.values[category];
							if (index >= numberOfBars) {
								categories.push(category);
								series.addPoint(value, false, false, true);
								mustRedraw = true;
							} else {
								var bar = series.data[index];
								if (categories[index] !== category || bar.y !== value) {

									if (categories[index] !== category && category !== 'Others') {
										bar.graphic.css({ 'fill-opacity': 0.75 });
										modifiedBars.push(bar);
									}

									categories[index] = category;
									bar.update(value, false, true);
									mustRedraw = true;
								}
							}
							index++;
						}
						for (var i = index; i < numberOfBars; i++) {
							series.data[i].remove(false, true);
							mustRedraw = true;
						}

						if (mustRedraw) {
							chart.redraw();
							(function(modifiedBars) {
								setTimeout(function() {
									modifiedBars.forEach(function(bar) {
										bar.graphic.css({'fill-opacity': 1});
									});
								}, 750);
							}(modifiedBars));
						}

					}
				};
			};
			
			var countries = vizarder('countries', 'column');
			var users = vizarder('users', 'line');

			function fetchData(callback) {
				$.getJSON('http://10.0.1.30:8008/v/freeall', callback);
			}
/*
			var graphValues = {
				"DK": 500,
				"US": 450,
				"DE": 300,
				"UK": 120,
				"SP":  80,
				"Others": 388
			};
			var count = 0;
			function fetchData(callback) {
				callback({
					country: {
						graph: {
							bar: {
								values: graphValues
							}
						}
					},
					users: {
						graph: {
							line: {
								x: [ 10,  20,  30,  40,  50,  60],
								y: [100, 110, 115, 130, 150, 154]
							}
						}
					}
				});
				if (++count === 5) {
					graphValues = {
						"DK": 500,
						"US": 450,
						"DE": 300,
						"UK": 120,
						"AR": 100,
						"Others": 408
					};
				}
			}

			$(window).click(function() {
				graphValues.UK += 10;
			});
*/

			function pollForMoreData() {
				fetchData(function(data) {
					countries.set(data.country.graph.bar);
					
					var values = {};
					
					for (var i=0; i<data.users.graph.line.x.length; i++) {
						values[data.users.graph.line.x[i]] = data.users.graph.line.y[i];
					}

					users.set({values: values});
				});
			}

			pollForMoreData();
			setInterval(pollForMoreData, 1000);
		</script>
	</head>
	<body>
		<h1>Vizard Graphs</h1>
		<div id="countries" class="left"></div>
		<div id="users" class="left"></div>
	</body>
</html>
