var buffoon = require('buffoon');
var common = require('common');

module.exports = function(fn) {
	return function(request, response) {
		var respond = function(status, headers, body) {
			if (typeof status !== 'number' && !headers) {
				body = status;
				headers = {};
				status = 200;
			} else if (!body) {
				body = headers;
				headers = {};
			}

			headers['content-type'] = headers['content-type'] || 'application/json';

			response.writeHead(status, headers);
			response.end(JSON.stringify(body, null, '  ')+'\n');
		};

		if (request.method === 'POST' || request.method === 'PUT') {
			buffoon.json(request, common.fork(fn, function(json) {
				fn(request, json, respond);
			}));
			return;
		}
		fn(request, respond);
	};
};